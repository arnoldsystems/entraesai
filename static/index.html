<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extração de Coluna Excel para Array</title>
    <style>
        .error { color: red; }
        .success { color: green; }
        .warning { color: orange; }
        .processing { color: blue; font-style: italic; }
        #output { 
            background-color: #f5f5f5;
            padding: 10px;
            margin-top: 10px;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
        }
        #results {
            margin-top: 20px;
        }
        form {
            margin: 20px 0;
        }
        button {
            margin-left: 10px;
            padding: 5px 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border-left: 4px solid #09f;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 10px;
            vertical-align: middle;
        }
        .progress-text {
            margin-left: 10px;
            font-weight: bold;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <!-- Adicionar a biblioteca SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <h2>Extração de Coluna do Excel e Busca por "Giramille"</h2>
    <form id="uploadForm" enctype="multipart/form-data">
        <input type="file" id="fileInput" name="file" accept=".xls, .xlsx">
        <button type="button" onclick="extractColumn()">Extrair e Processar</button>
    </form>
    <p id="status"></p>
    <div id="loadingIndicator" style="display:none;">
        <div class="spinner"></div> 
        Processando sites... <span id="progressText"></span>
    </div>
    <pre id="output"></pre>
    
    <div id="results">
        <h3>Resultados da Busca</h3>
        <table id="resultsTable" style="display:none;">
            <thead>
                <tr>
                    <th>#</th>
                    <th>URL/Site</th>
                    <th>Status da Busca por "Giramille"</th>
                    <th>Progresso</th>
                </tr>
            </thead>
            <tbody id="resultsBody">
            </tbody>
        </table>
    </div>

    <script>
        let pollingInterval = null;
        let columnArrayLength = 0;
        
        async function extractColumn() {
            const statusElement = document.getElementById("status");
            const outputElement = document.getElementById("output");
            const loadingIndicator = document.getElementById("loadingIndicator");
            const progressText = document.getElementById("progressText");
            const fileInput = document.getElementById("fileInput");
            const file = fileInput.files[0];

            if (!file) {
                statusElement.className = "error";
                statusElement.innerText = "Nenhum arquivo selecionado.";
                return;
            }

            statusElement.innerText = "Processando arquivo...";

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Obter a primeira planilha
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // Converter para JSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    // Extrair a primeira coluna para um array
                    const columnArray = [];
                    
                    if (jsonData.length > 0) {
                        for (let i = 0; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            if (row.length >= 2 && row[0] && row[1]) {
                                const url = String(row[0]).trim();
                                const term = String(row[1]).trim();
                                if (url && term) {
                                    columnArray.push({ url, term });
                                }
                            }
                        }
                        
                        columnArrayLength = columnArray.length;
                        
                        // Exibir o array no frontend
                        outputElement.innerText = JSON.stringify(columnArray, null, 2);
                        
                        // Limpar tabela de resultados anteriores
                        document.getElementById('resultsBody').innerHTML = '';
                        document.getElementById('resultsTable').style.display = 'none';
                        
                        // Mostrar mensagem de total de sites
                        progressText.innerText = `Preparando para processar ${columnArray.length} sites...`;
                        
                        // Enviar o array para o backend
                        try {
                            statusElement.className = "";
                            statusElement.innerText = "Iniciando o processamento...";
                            loadingIndicator.style.display = "block";
                            
                            const response = await fetch("/process-column", {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json"
                                },
                                body: JSON.stringify({
                                    columnData: columnArray
                                })
                            });
                            
                            const responseData = await response.json();
                            
                            if (responseData.error) {
                                loadingIndicator.style.display = "none";
                                statusElement.className = "error";
                                statusElement.innerText = "Erro no servidor: " + responseData.error;
                            } else {
                                // Iniciar o polling para verificar o progresso
                                document.getElementById('resultsTable').style.display = 'table';
                                startPolling();
                            }
                        } catch (error) {
                            loadingIndicator.style.display = "none";
                            statusElement.className = "error";
                            statusElement.innerText = "Erro ao enviar dados para o servidor: " + error.message;
                        }
                    } else {
                        statusElement.className = "error";
                        statusElement.innerText = "Arquivo Excel vazio ou sem dados.";
                    }
                    
                } catch (error) {
                    statusElement.className = "error";
                    statusElement.innerText = "Erro ao processar o arquivo: " + error.message;
                    outputElement.innerText = "";
                }
            };
            
            reader.onerror = function() {
                statusElement.className = "error";
                statusElement.innerText = "Erro na leitura do arquivo";
                outputElement.innerText = "";
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        function startPolling() {
            // Limpar qualquer polling anterior
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }
            
            // Consultar o servidor a cada 1 segundo para atualizações
            pollingInterval = setInterval(checkProgress, 1000);
        }
        
        async function checkProgress() {
            try {
                const response = await fetch("/check-progress");
                const data = await response.json();
                
                updateResultsTable(data.results);
                
                // Atualizar mensagem de progresso
                const processedCount = data.results.filter(r => r.status !== "Processando...").length;
                document.getElementById('progressText').innerText = 
                    `${processedCount} de ${columnArrayLength} sites processados`;
                
                // Se o processamento estiver completo, parar o polling
                if (data.complete) {
                    clearInterval(pollingInterval);
                    
                    const loadingIndicator = document.getElementById("loadingIndicator");
                    loadingIndicator.style.display = "none";
                    
                    // Contagem final de status
                    let successCount = 0;
                    let failCount = 0;
                    let timeoutCount = 0;
                    let errorCount = 0;
                    
                    data.results.forEach(result => {
                        if (result.status === "Busca realizada") {
                            successCount++;
                        } else if (result.status === "Campo de busca não encontrado") {
                            failCount++;
                        } else if (result.status.startsWith("Timeout")) {
                            timeoutCount++;
                        } else if (result.status.startsWith("Erro")) {
                            errorCount++;
                        }
                    });
                    
                    const statusElement = document.getElementById("status");
                    statusElement.className = "success";
                    statusElement.innerText = `Processamento concluído! ${data.results.length} sites verificados. 
                                             Sucessos: ${successCount}, Falhas: ${failCount}, Timeouts: ${timeoutCount}, Erros: ${errorCount}`;
                    
                    // Se houve um erro global, mostrar
                    if (data.error) {
                        const errorElement = document.createElement("p");
                        errorElement.className = "error";
                        errorElement.innerText = `Erro durante o processamento: ${data.error}`;
                        document.getElementById("results").prepend(errorElement);
                    }
                }
            } catch (error) {
                console.error("Erro ao verificar progresso:", error);
            }
        }
        
        function updateResultsTable(results) {
            const resultsBody = document.getElementById('resultsBody');
            
            // Limpar tabela existente
            resultsBody.innerHTML = '';
            
            for (let i = 0; i < results.length; i++) {
                const result = results[i];
                const row = document.createElement('tr');
                
                // Adicionar número do índice
                const indexCell = document.createElement('td');
                indexCell.textContent = i + 1;
                row.appendChild(indexCell);
                
                // Adicionar URL
                const urlCell = document.createElement('td');
                urlCell.textContent = result.url;
                row.appendChild(urlCell);
                
                // Adicionar status
                const statusCell = document.createElement('td');
                statusCell.textContent = result.status;
                
                // Aplicar estilo baseado no status
                if (result.status === "Busca realizada") {
                    statusCell.className = "success";
                } else if (result.status === "Campo de busca não encontrado") {
                    statusCell.className = "warning";
                } else if (result.status.startsWith("Timeout")) {
                    statusCell.className = "warning";
                } else if (result.status.startsWith("Erro")) {
                    statusCell.className = "error";
                } else if (result.status === "Processando...") {
                    statusCell.className = "processing";
                }
                
                row.appendChild(statusCell);
                
                // Adicionar coluna de progresso
                const progressCell = document.createElement('td');
                progressCell.textContent = result.progress;
                row.appendChild(progressCell);
                
                resultsBody.appendChild(row);
            }
        }
    </script>
</body>
</html>